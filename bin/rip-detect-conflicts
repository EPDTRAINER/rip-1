#!/usr/bin/env ruby
# Usage: rip-detect-conflicts deps.rip
# Determines whether any dependencies (or their dependencies)
# specified in a deps.rip conflicts with the packages installed in the
# current ripenv (or each other).
#
# Exit codes:
#   0 No conflicts
#   1 Conflicts (printed)
#   4 Given .rip file not found
#
# On conflict, prints YAML of failed package, who is trying to install
# it at what version, and who already installed it at what version.

require 'rip/script'

env = Environment.new

rip("installed").split("\n").each do |package|
  env.merge("#{package}/metadata.rip")
end

ARGV.each do |arg|
  exit 4 unless File.exists?(arg)
  env.merge(arg)
end

if env.conflicts?
  warn env.conflicts.join("\n")
  exit 1
end
