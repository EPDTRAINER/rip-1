#!/usr/bin/env ruby
# Usage: rip-detect-conflicts deps.rip
#
# Determines whether any dependencies (or their dependencies)
# specified in a deps.rip conflicts with the packages installed in the
# current ripenv (or each other).
#
# Exit codes:
#   0 No conflicts
#   1 Conflicts (printed)
#   4 Given .rip file not found
#
# On conflict prints each failed package.

require 'rip/script'

env = Environment.new

rip("installed").split("\n").each do |package|
  env.merge("#{package}/metadata.rip")
end

ARGV.each do |arg|
  exit 4 if arg.include?('/') && !File.exists?(arg)
  env.merge(arg)
end

if env.conflicts?
  warn "Conflicts"

  env.conflicts.each do |package|
    installed_at = env[package.name].version
    warn "  #{package.name}"
    warn "    #{package.version} requested, #{installed_at} already installed"
  end

  exit 1
end
