#!/usr/bin/env ruby
# Usage: rip-fetch-dependencies PACKAGE
# Fetch dependencies with a breadth-first traversal

$-e = true

require 'rip/script'
require 'set'

original = []
fetched  = []
queue    = []

if ARGV.any?
  ARGV.each do |path|
    original << path
    queue << path
  end
else
  $stdin.each_line do |path|
    path.chomp!
    original << path
    queue << path
  end
end

while queue.any?
  package_path = queue.shift
  fetched << package_path

  if !original.include?(package_path)
    puts package_path
  end

  if File.exist?(deps = "#{package_path}/deps.rip")
    debug "found #{deps}"

    rip(:package, deps) do |dep_path|
      if !fetched.include?(dep_path) && !queue.include?(dep_path)
        queue << dep_path
      end
    end
  end
end
