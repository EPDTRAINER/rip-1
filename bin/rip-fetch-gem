#!/usr/bin/env ruby
# Usage: rip-fetch-gem URL

require 'rip/script'

target  = ARGV[0]

if ARGV[1] =~ /^\//
  path    = ARGV[1]
  version = ARGV[2]
else
  path    = "/"
  version = ARGV[1]
end

version = sh "rip-deref-gem #{target} #{version}"
package = Rip::GemPackage.new(target, path, version)

cache    = package.cache_path
packages = package.package_path

sh "rip-cache-gem #{target} #{version}"

if File.directory?(packages)
  puts packages
elsif path == "/"
  mkdir_p Rip.packages
  cd Rip.packages
  if path = sh("gem unpack '#{cache}' --target='#{Rip.packages}'") =~ /^Unpacked gem: '(.+)'$/
    mv $1, packages
    puts packages
  else
    exit 1
  end
else
  base_package = sh "rip-fetch #{target} #{version}"
  if !File.exist?("#{base_package}#{path}")
    abort "#{target} #{path} does not exist"
  end
  ln_s "#{base_package}#{path}", packages
  puts packages
end
