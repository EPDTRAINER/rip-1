#!/usr/bin/env ruby
# Usage: rip-package-gem NAME VERSION

source  = ARGV[0]
version = ARGV[1]

unless source =~ /\.gem$/ || source =~ /^(\w|-)+$/
  exit 3 # Can't handle source
end

require 'rip/script'

def list(name)
  rpg_available? ? rpg_list(name) : gem_list(name)
end

def unpack(name, version)
  info "fetching #{name} #{version}"
  rpg_available? ? rpg_unpack(name, version) : gem_unpack(name, version)
end

def dependencies(name, version)
  # if rpg_available?
  #   rpg_dependencies(name, version)
  # else
    gem_dependencies(name, version)
  # end
end

def gem_list(name)
  gems = gem("list #{name} --remote").split("\n")
  if gems.detect { |f| f =~ /^#{name} \((.+)\)/ }
    $1
  end
end

def gem_unpack(name, version)
  path = gem_path = nil

  cd Rip.cache do
    begin
      if gem("fetch", name, "-v #{version}") =~ /Downloaded (.+)/
        gem_path = File.expand_path($1) + ".gem"
      else
        gem = name.dup
        gem << " #{version}" if version
        abort "#{gem} not found"
      end

      sh("gem unpack '#{gem_path}' --target='#{Rip.packages}'") =~
        /^Unpacked gem: '(.+)'$/
      path = $1
    ensure
      rm_rf gem_path if File.exist?(gem_path.to_s)
    end
  end

  if path.nil?
    abort "#{name} #{version} not found"
  end

  path
end

def gem_dependencies(name, version)
  deps = gem("dependency --pipe -r /^#{name}$/ -v #{version}")

  deps.split("\n").map do |dep|
    parts = dep.split(' ')
    source, version = parts.first, parts.last.chomp("'")
    version == "0" ? source : "#{source} #{version}"
  end
end

def rpg_list(name)
  if rpg("list -a #{name}") =~ /^#{name} (.+)$/
    $1
  end
end

def rpg_unpack(name, version)
  if path = rpg("unpack #{name} #{version}")
    path.chomp
  end
end

# def rpg_dependencies(name, version)
#   rpg("dependencies #{name} #{version}").split("\n").map do |dep|
#     source, tweedle, version = dep.split(' ')
#     version == "0" ? source : "#{source} #{version}"
#   end
# end

version ||= list(source)

package_path = "#{Rip.packages}/#{source}-#{Rip.md5("#{source}#{version}")}"

synchronize(package_path) do
  if File.directory?(package_path)
    puts package_path
    exit 0
  end

  cd Rip.packages

  path = unpack(source, version)

  if !File.exist?(path)
    abort "#{source} #{version} not found"
  end

  mv path, package_path

  File.open("#{package_path}/metadata.rip", 'w') do |f|
    f.puts "#{source} #{version}"
  end

  if !File.exists?(deps_rip = "#{package_path}/deps.rip")
    deps = dependencies(source, version)

    if deps.any?
      File.open(deps_rip, 'w') do |f|
        f.puts deps.join("\n")
      end
    end
  end

  puts package_path
end
